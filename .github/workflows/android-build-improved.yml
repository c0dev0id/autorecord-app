name: Android CI Build Improved

on:
  push:
    branches: [ main, develop, claude/** ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  # Job 1: Unit Tests - Runs fast, fails fast
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest --stacktrace --build-cache --parallel

      - name: Generate Test Coverage Report
        if: always()
        run: ./gradlew jacocoTestReport || echo "Coverage report generation failed or not configured"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            app/build/reports/tests/**
            app/build/test-results/**
          retention-days: 30

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            app/build/reports/jacoco/**
          retention-days: 30

      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: '**/build/test-results/test**/TEST-*.xml'
          check_name: Unit Test Results
          detailed_summary: true
          include_passed: true

  # Job 2: Lint & Code Quality - Runs in parallel with tests
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties

      - name: Run Android Lint
        run: ./gradlew lintDebug --stacktrace --build-cache --parallel

      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            app/build/reports/lint-results-*.html
            app/build/reports/lint-results-*.xml
          retention-days: 30

      - name: Annotate Lint Results
        if: always()
        uses: yutailang0119/action-android-lint@v3
        with:
          report-path: app/build/reports/lint-results-*.xml
        continue-on-error: true

  # Job 3: Security Check - Dependency vulnerability scanning
  security:
    name: Security & Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Run Dependency Check
        run: ./gradlew dependencies > dependencies.txt || echo "Dependency check completed"

      - name: Upload Dependency Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependencies.txt
          retention-days: 30

  # Job 4: Build APK - Only runs if tests and lint pass
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --build-cache --parallel

      - name: Get APK Info
        id: apk_info
        run: |
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          APK_SIZE=$(stat -c%s "$APK_PATH" 2>/dev/null || stat -f%z "$APK_PATH")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
          echo "apk_size_mb=$APK_SIZE_MB" >> $GITHUB_OUTPUT
          echo "apk_size_bytes=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "APK Size: ${APK_SIZE_MB} MB"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: Build Info Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… APK built successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK Size:** ${{ steps.apk_info.outputs.apk_size_mb }} MB" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type:** Debug" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

  # Job 5: PR Comment - Add summary comment to pull requests
  pr-comment:
    name: PR Comment with Results
    runs-on: ubuntu-latest
    needs: [test, lint, build]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results
        continue-on-error: true

      - name: Create PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            let comment = '## ðŸš€ CI/CD Pipeline Results\n\n';
            comment += '### âœ… All Checks Passed!\n\n';
            comment += '| Check | Status |\n';
            comment += '|-------|--------|\n';
            comment += '| Unit Tests | âœ… Passed |\n';
            comment += '| Lint | âœ… Passed |\n';
            comment += '| Build | âœ… Success |\n\n';
            comment += '### ðŸ“¦ Artifacts\n';
            comment += '- Debug APK is available in the workflow artifacts\n\n';
            comment += `**Commit:** ${context.sha.substring(0, 7)}\n`;
            comment += `**Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
