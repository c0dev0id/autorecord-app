name: Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v1.0.0) - leave empty to auto-increment patch version'
        required: false
        type: string

# Only one release workflow at a time
concurrency:
  group: release-pipeline
  cancel-in-progress: false

jobs:
  # Job 1: Warm caches
  warm-caches:
    name: Warm Gradle Caches
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties

      - name: Warm up Gradle cache
        run: ./gradlew tasks --no-daemon --build-cache

  # Job 2: Build release APK (optionally signed)
  build:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: warm-caches
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Restore Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties

      # Optional: Setup signing if secrets are available
      - name: Setup Signing (Optional)
        # Avoid using secrets in the step-level expression to prevent linter issues;
        # instead provide them as env vars and handle checks in the shell.
        env:
          SIGNING_KEYSTORE_PASSWORD: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS:    ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEYSTORE_BASE64: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
      
          if [ -n "${SIGNING_KEYSTORE_PASSWORD:-}" ]; then
            echo "storeFile=../release.keystore" > keystore.properties
            echo "storePassword=${SIGNING_KEYSTORE_PASSWORD}" >> keystore.properties
            echo "keyAlias=${SIGNING_KEY_ALIAS:-release}" >> keystore.properties
            echo "keyPassword=${SIGNING_KEYSTORE_PASSWORD}" >> keystore.properties
      
            # If keystore provided as base64 secret, decode it
            if [ -n "${SIGNING_KEYSTORE_BASE64:-}" ]; then
              echo "$SIGNING_KEYSTORE_BASE64" | base64 -d > release.keystore
            fi
      
            echo "Signing configuration written to keystore.properties"
          else
            echo "Signing secrets not provided; skipping signing setup."
          fi

      # Build Debug APKs (mandatory - always required for release)
      - name: Build Debug APKs
        run: |
          ./gradlew assembleDebug --stacktrace --build-cache --parallel

      # Build Release APKs (optional - only if signing is configured)
      - name: Build Release APKs
        id: build_release
        continue-on-error: true
        run: |
          ./gradlew assembleRelease --stacktrace --build-cache --parallel

      # Upload Debug APKs (mandatory)
      - name: Upload Debug APKs
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: |
            app/build/outputs/apk/debug/*.apk
            vnmanager-opener/build/outputs/apk/debug/*.apk
          retention-days: 90

      # Upload Release APKs (optional - only if build succeeded)
      - name: Upload Release APKs
        if: steps.build_release.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: |
            app/build/outputs/apk/release/*.apk
            vnmanager-opener/build/outputs/apk/release/*.apk
          retention-days: 90
      
      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Release Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Debug APKs (mandatory)
          echo "### Debug APKs (Mandatory)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Voice Notes debug APK
          echo "**Voice Notes App (Debug)**" >> $GITHUB_STEP_SUMMARY
          DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
          if [ -f "$DEBUG_APK" ]; then
            DEBUG_SIZE=$(stat -c%s "$DEBUG_APK" 2>/dev/null || stat -f%z "$DEBUG_APK")
            DEBUG_SIZE_MB=$(echo "scale=2; $DEBUG_SIZE / 1024 / 1024" | bc)
            echo "- APK Size: ${DEBUG_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
            echo "- Status: âœ… Built successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Status: âŒ Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check VN Manager Opener debug APK
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VN Manager Opener (Debug)**" >> $GITHUB_STEP_SUMMARY
          OPENER_DEBUG=$(find vnmanager-opener/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
          if [ -f "$OPENER_DEBUG" ]; then
            OPENER_DEBUG_SIZE=$(stat -c%s "$OPENER_DEBUG" 2>/dev/null || stat -f%z "$OPENER_DEBUG")
            OPENER_DEBUG_SIZE_MB=$(echo "scale=2; $OPENER_DEBUG_SIZE / 1024 / 1024" | bc)
            echo "- APK Size: ${OPENER_DEBUG_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
            echo "- Status: âœ… Built successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Status: âŒ Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Release APKs (optional)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release APKs (Optional - requires signing)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Voice Notes release APK
          echo "**Voice Notes App (Release)**" >> $GITHUB_STEP_SUMMARY
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
          if [ -f "$RELEASE_APK" ]; then
            RELEASE_SIZE=$(stat -c%s "$RELEASE_APK" 2>/dev/null || stat -f%z "$RELEASE_APK")
            RELEASE_SIZE_MB=$(echo "scale=2; $RELEASE_SIZE / 1024 / 1024" | bc)
            echo "- APK Size: ${RELEASE_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
            
            if [[ "$RELEASE_APK" == *"unsigned"* ]]; then
              echo "- Status: âš ï¸ Unsigned (signing not configured)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Status: âœ… Signed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Status: âš ï¸ Not available (signing not configured)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check VN Manager Opener release APK
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VN Manager Opener (Release)**" >> $GITHUB_STEP_SUMMARY
          OPENER_RELEASE=$(find vnmanager-opener/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
          if [ -f "$OPENER_RELEASE" ]; then
            OPENER_RELEASE_SIZE=$(stat -c%s "$OPENER_RELEASE" 2>/dev/null || stat -f%z "$OPENER_RELEASE")
            OPENER_RELEASE_SIZE_MB=$(echo "scale=2; $OPENER_RELEASE_SIZE / 1024 / 1024" | bc)
            echo "- APK Size: ${OPENER_RELEASE_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
            
            if [[ "$OPENER_RELEASE" == *"unsigned"* ]]; then
              echo "- Status: âš ï¸ Unsigned (signing not configured)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Status: âœ… Signed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Status: âš ï¸ Not available (signing not configured)" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 3: Run critical smoke tests (optional Firebase Test Lab)
  smoke-tests:
    name: Critical Smoke Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 60
    if: github.event_name == 'workflow_dispatch'  # Only run on manual dispatch
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Debug APKs
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: apks/debug/

      - name: Download Release APKs
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: app-release-apk
          path: apks/release/

      - name: Run Local Smoke Test
        run: |
          echo "Running local smoke tests..."
          echo "âœ… APK smoke test passed (placeholder)"
          # Add actual smoke test logic here if needed

  # Job 4: Upload release artifacts - creates GitHub Release
  upload-release-artifacts:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Debug APKs
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: apks/debug/

      - name: Download Release APKs
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: app-release-apk
          path: apks/release/

      - name: Determine Release Tag
        id: release_info
        env:
          DISPATCH_TAG: ${{ github.event.inputs.release_version }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          # 1) Prefer explicit workflow_dispatch input
          if [ -n "${DISPATCH_TAG:-}" ]; then
            TAG="${DISPATCH_TAG}"
          # 2) If run was triggered by a tag push, use the pushed tag
          elif [ -n "${GITHUB_REF_NAME:-}" ]; then
            TAG="${GITHUB_REF_NAME}"
          else
            # 3) Otherwise compute next patch from latest semver tag
            git fetch --tags --quiet
            LATEST_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)

            if [ -z "${LATEST_TAG}" ]; then
              # No tags yet, start at v0.0.1
              TAG="v0.0.1"
            else
              # Strip leading v if present and split into parts
              BASE=${LATEST_TAG#v}
              IFS='.' read -r MAJOR MINOR PATCH <<< "${BASE}"
              # Ensure PATCH is numeric; safe fallback
              if ! printf '%s' "${PATCH}" | grep -Eq '^[0-9]+$'; then
                PATCH=0
              fi
              PATCH=$((PATCH + 1))
              TAG="v${MAJOR}.${MINOR}.${PATCH}"
            fi
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Release tag: ${TAG}"

          if printf '%s' "${TAG}" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Find and Prepare APK Files
        id: find_apks
        run: |
          # Find Debug APKs (mandatory)
          APP_DEBUG_APK=$(find apks/debug/app/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$APP_DEBUG_APK" ]; then
            cp "$APP_DEBUG_APK" voice-notes-debug.apk
            echo "Found Voice Notes Debug APK: $APP_DEBUG_APK"
          else
            echo "Warning: Voice Notes Debug APK not found!"
          fi
          
          OPENER_DEBUG_APK=$(find apks/debug/vnmanager-opener/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$OPENER_DEBUG_APK" ]; then
            cp "$OPENER_DEBUG_APK" vnmanager-opener-debug.apk
            echo "Found VN Manager Opener Debug APK: $OPENER_DEBUG_APK"
          else
            echo "Warning: VN Manager Opener Debug APK not found!"
          fi
          
          # Find Release APKs (optional)
          APP_RELEASE_APK=$(find apks/release/app/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$APP_RELEASE_APK" ]; then
            cp "$APP_RELEASE_APK" voice-notes-release.apk
            echo "Found Voice Notes Release APK: $APP_RELEASE_APK"
          else
            echo "Info: Voice Notes Release APK not available (signing not configured)"
          fi
          
          OPENER_RELEASE_APK=$(find apks/release/vnmanager-opener/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$OPENER_RELEASE_APK" ]; then
            cp "$OPENER_RELEASE_APK" vnmanager-opener-release.apk
            echo "Found VN Manager Opener Release APK: $OPENER_RELEASE_APK"
          else
            echo "Info: VN Manager Opener Release APK not available (signing not configured)"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: Release ${{ steps.release_info.outputs.tag }}
          draft: ${{ steps.release_info.outputs.is_release == 'false' }}
          prerelease: ${{ steps.release_info.outputs.is_release == 'false' }}
          body: |
            ## Release ${{ steps.release_info.outputs.tag }}
            
            ### Changes
            - See CHANGELOG.md for details
            
            ### APK Files
            This release includes Android applications in both debug and release variants:
            
            **Debug APKs (Always included):**
            - `voice-notes-debug.apk` - Main motorcycle voice notes recording application
            - `vnmanager-opener-debug.apk` - Companion utility for managing voice notes
            
            **Release APKs (Included when signing is configured):**
            - `voice-notes-release.apk` - Signed production-ready app (Package: com.voicenotes.motorcycle)
            - `vnmanager-opener-release.apk` - Signed companion utility (Package: com.vnmanager.opener)
            
            Debug APKs are suitable for testing and development. Release APKs are production-ready and signed for distribution.
          files: |
            voice-notes-debug.apk
            vnmanager-opener-debug.apk
            voice-notes-release.apk
            vnmanager-opener-release.apk
          fail_on_unmatched_files: false

  # Job 5: Publish to Play Store (OPTIONAL - commented out by default)
  # Uncomment and configure this job to enable automatic Play Store publishing
  # publish-play-store:
  #   name: Publish to Google Play Store
  #   runs-on: ubuntu-latest
  #   needs: [build, smoke-tests]
  #   timeout-minutes: 30
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Download Release APK
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: app-release-apk
  #         path: apks/
  #
  #     - name: Publish to Play Store
  #       uses: r0adkll/upload-google-play@v1
  #       with:
  #         serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
  #         packageName: com.voicenotes.motorcycle
  #         releaseFiles: apks/app-release.apk
  #         track: production
  #         status: completed
  #         whatsNewDirectory: docs/whatsnew/
  #         mappingFile: app/build/outputs/mapping/release/mapping.txt

  # Final status summary
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [build, upload-release-artifacts]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Generate Release Summary
        run: |
          echo "## ðŸš€ Release Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Upload: ${{ needs.upload-release-artifacts.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build.result }}" == "success" ]] && [[ "${{ needs.upload-release-artifacts.result }}" == "success" ]]; then
            echo "âœ… Release completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Release pipeline failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
