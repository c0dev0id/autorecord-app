name: Production Readiness

on:
  workflow_dispatch:

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Warm caches
  warm-caches:
    name: Warm Gradle Caches
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties
          echo "APP_VERSION=$(git describe --tags --always --dirty)" >> gradle.properties

      - name: Warm up Gradle cache
        run: ./gradlew tasks --no-daemon --build-cache

  # Job 2: Full build with all variants
  build:
    name: Build All Variants
    runs-on: ubuntu-latest
    needs: warm-caches
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Restore Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties
          echo "APP_VERSION=$(git describe --tags --always --dirty)" >> gradle.properties

      # Optional: Setup signing if secrets are available
      - name: Setup Signing (Optional)
        env:
          SIGNING_KEYSTORE_PASSWORD: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEYSTORE_BASE64: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
      
          if [ -n "${SIGNING_KEYSTORE_PASSWORD:-}" ] && [ -n "${SIGNING_KEYSTORE_BASE64:-}" ]; then
            echo "storeFile=../release.keystore" > keystore.properties
            echo "storePassword=${SIGNING_KEYSTORE_PASSWORD}" >> keystore.properties
            echo "keyAlias=${SIGNING_KEY_ALIAS:-release}" >> keystore.properties
            echo "keyPassword=${SIGNING_KEYSTORE_PASSWORD}" >> keystore.properties
            chmod 600 keystore.properties
      
            # Decode the keystore
            echo "$SIGNING_KEYSTORE_BASE64" | base64 -d > release.keystore
            chmod 600 release.keystore
      
            echo "Signing configuration written to keystore.properties"
          else
            echo "Signing secrets not provided; will build unsigned release APKs."
          fi

      - name: Build All Variants
        run: |
          ./gradlew assembleDebug assembleRelease --stacktrace --build-cache --parallel

      - name: Upload Voice Notes Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: voice-notes-debug-apk
          path: voicenotes/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Upload Voice Notes Release APK
        uses: actions/upload-artifact@v4
        with:
          name: voice-notes-release-apk
          path: voicenotes/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload VN Manager Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: vnmanager-debug-apk
          path: vnmanager/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Upload VN Manager Release APK
        uses: actions/upload-artifact@v4
        with:
          name: vnmanager-release-apk
          path: vnmanager/build/outputs/apk/release/*.apk
          retention-days: 30

  # Job 3a: Static Analysis - Lint
  lint:
    name: Android Lint
    runs-on: ubuntu-latest
    needs: warm-caches
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Restore Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties
          echo "APP_VERSION=$(git describe --tags --always --dirty)" >> gradle.properties

      - name: Run Android Lint
        run: ./gradlew lintDebug lintRelease --stacktrace --build-cache --parallel

      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            voicenotes/build/reports/lint-results-*.html
            voicenotes/build/reports/lint-results-*.xml
          retention-days: 30

  # Job 3b: Static Analysis - KtLint/Detekt
  ktlint:
    name: Kotlin Style Check
    runs-on: ubuntu-latest
    needs: warm-caches
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run KtLint
        run: |
          curl -sSLO https://github.com/pinterest/ktlint/releases/download/1.0.1/ktlint
          chmod +x ktlint
          ./ktlint "voicenotes/src/**/*.kt" --reporter=plain --reporter=checkstyle,output=ktlint-report.xml || true

      - name: Upload KtLint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-report
          path: ktlint-report.xml
          retention-days: 30

  # Job 3c: Static Analysis - CodeQL
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: warm-caches
    timeout-minutes: 60
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Restore Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java-kotlin
          queries: security-and-quality

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties
          echo "APP_VERSION=$(git describe --tags --always --dirty)" >> gradle.properties

      - name: Build for CodeQL
        run: ./gradlew assembleDebug --stacktrace --build-cache

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java-kotlin"

  # Job 5: Coverage
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: warm-caches
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Restore Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties
          echo "APP_VERSION=$(git describe --tags --always --dirty)" >> gradle.properties

      - name: Generate Coverage Report
        run: ./gradlew testDebugUnitTest jacocoTestReport --stacktrace --build-cache

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: voicenotes/build/reports/jacoco/
          retention-days: 30

  # Job 6: Upload Artifacts - Creates draft release with raw APKs
  upload-artifacts:
    name: Upload Release Artifacts
    runs-on: ubuntu-latest
    needs: [build, lint, codeql]
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    timeout-minutes: 15
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Voice Notes Debug APK
        uses: actions/download-artifact@v4
        with:
          name: voice-notes-debug-apk
          path: apks/voice-notes/debug/

      - name: Download Voice Notes Release APK
        uses: actions/download-artifact@v4
        with:
          name: voice-notes-release-apk
          path: apks/voice-notes/release/

      - name: Download VN Manager Debug APK
        uses: actions/download-artifact@v4
        with:
          name: vnmanager-debug-apk
          path: apks/vnmanager/debug/

      - name: Download VN Manager Release APK
        uses: actions/download-artifact@v4
        with:
          name: vnmanager-release-apk
          path: apks/vnmanager/release/

      - name: Generate Release Tag
        id: release_tag
        run: |
          TAG="draft-$(date +'%Y%m%d-%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Create Draft Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          release_name: Draft Release ${{ steps.release_tag.outputs.tag }}
          draft: true
          prerelease: true

      - name: Find and Upload APKs to Release
        run: |
          # Find and upload Voice Notes Debug APK
          VOICE_NOTES_DEBUG=$(find apks/voice-notes/debug -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$VOICE_NOTES_DEBUG" ]; then
            echo "Found Voice Notes Debug APK: $VOICE_NOTES_DEBUG"
            gh release upload "${{ steps.release_tag.outputs.tag }}" "$VOICE_NOTES_DEBUG" --clobber --repo "${{ github.repository }}"
          else
            echo "Warning: Voice Notes Debug APK not found"
          fi
          
          # Find and upload Voice Notes Release APK
          VOICE_NOTES_RELEASE=$(find apks/voice-notes/release -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$VOICE_NOTES_RELEASE" ]; then
            echo "Found Voice Notes Release APK: $VOICE_NOTES_RELEASE"
            gh release upload "${{ steps.release_tag.outputs.tag }}" "$VOICE_NOTES_RELEASE" --clobber --repo "${{ github.repository }}"
          else
            echo "Warning: Voice Notes Release APK not found (signing may not be configured)"
          fi
          
          # Find and upload VN Manager Debug APK
          VNMANAGER_DEBUG=$(find apks/vnmanager/debug -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$VNMANAGER_DEBUG" ]; then
            echo "Found VN Manager Debug APK: $VNMANAGER_DEBUG"
            gh release upload "${{ steps.release_tag.outputs.tag }}" "$VNMANAGER_DEBUG" --clobber --repo "${{ github.repository }}"
          else
            echo "Warning: VN Manager Debug APK not found"
          fi
          
          # Find and upload VN Manager Release APK
          VNMANAGER_RELEASE=$(find apks/vnmanager/release -name "*.apk" 2>/dev/null | head -1)
          if [ -n "$VNMANAGER_RELEASE" ]; then
            echo "Found VN Manager Release APK: $VNMANAGER_RELEASE"
            gh release upload "${{ steps.release_tag.outputs.tag }}" "$VNMANAGER_RELEASE" --clobber --repo "${{ github.repository }}"
          else
            echo "Warning: VN Manager Release APK not found (signing may not be configured)"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 7: Update caches
  update-caches:
    name: Update Gradle Caches
    runs-on: ubuntu-latest
    needs: [build, lint, ktlint, codeql, coverage]
    if: always()
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Update Gradle Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create gradle.properties
        run: |
          echo "GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON=${{ toJSON(secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON) }}" >> gradle.properties
          echo "OSM_CLIENT_ID=${{ secrets.OSM_CLIENT_ID }}" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "kotlin.code.style=official" >> gradle.properties
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.configureondemand=true" >> gradle.properties
          echo "APP_VERSION=$(git describe --tags --always --dirty)" >> gradle.properties

      - name: Update cache
        run: ./gradlew tasks --no-daemon --build-cache

  # Job 8: Final aggregation - reports overall status
  aggregation:
    name: Final Status Check
    runs-on: ubuntu-latest
    needs: [build, lint, ktlint, codeql, coverage, update-caches]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Check Job Results
        run: |
          echo "## ðŸ“Š Production Readiness Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "KtLint: ${{ needs.ktlint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "CodeQL: ${{ needs.codeql.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Coverage: ${{ needs.coverage.result }}" >> $GITHUB_STEP_SUMMARY
          
          # Fail if critical checks failed
          if [[ "${{ needs.build.result }}" == "failure" ]] || [[ "${{ needs.codeql.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Critical checks failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All critical checks passed!" >> $GITHUB_STEP_SUMMARY
